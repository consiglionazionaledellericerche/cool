<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:activiti="http://activiti.org/bpmn" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:omgdc="http://www.omg.org/spec/DD/20100524/DC" xmlns:omgdi="http://www.omg.org/spec/DD/20100524/DI" typeLanguage="http://www.w3.org/2001/XMLSchema" expressionLanguage="http://www.w3.org/1999/XPath" targetNamespace="http://www.activiti.org">
  <process id="flussoFirma" name="FLUSSO FIRMA" isExecutable="true">
    <extensionElements>
      <activiti:executionListener event="start" class="org.alfresco.repo.workflow.activiti.listener.ScriptExecutionListener">
        <activiti:field name="script">
          <activiti:string><![CDATA[<import resource="/Company Home/Data Dictionary/Scripts/wfContatori.js">
			<import resource="/Company Home/Data Dictionary/Scripts/wfFirmaDigitale.js">
			if (wfFirmaDigitale.controlloStart(bpm_package)){
				var nodoDocumento = bpm_package.children[0];
				wfContatori.inizializza();
				wfFirmaDigitale.inizializza(nodoDocumento);
				execution.setVariable('bpm_dueDate', bpm_workflowDueDate);
				execution.setVariable('bpm_assignee', initiator);
				// // logger.error("FLUSSO FIRMA - Avvia assegnando a ufficio: " + bpm_groupAssignee.properties.authorityName);
			}]]></activiti:string>
        </activiti:field>
        <activiti:field name="runAs">
          <activiti:string><![CDATA[admin]]></activiti:string>
        </activiti:field>
      </activiti:executionListener>
      <activiti:executionListener event="end" class="org.alfresco.repo.workflow.activiti.listener.ScriptExecutionListener">
        <activiti:field name="script">
          <activiti:string><![CDATA[<import resource="/Company Home/Data Dictionary/Scripts/wfFirmaDigitale.js">
				var nodoDocumento = bpm_package.children[0];
				wfFirmaDigitale.finalizza(nodoDocumento);
				// // logger.error("FLUSSO FIRMA - END");
				]]></activiti:string>
        </activiti:field>
        <activiti:field name="runAs">
          <activiti:string><![CDATA[admin]]></activiti:string>
        </activiti:field>
      </activiti:executionListener>
    </extensionElements>
    <startEvent id="avvia" name="Avvia" activiti:formKey="cnrfirma:submitFlussoFirmaTask">
      <documentation>avvio flusso per firma documento</documentation>
    </startEvent>
    <userTask id="approvaDocumento" name="APPROVA DOCUMENTO" activiti:candidateGroups="${bpm_groupAssignee.properties.authorityName}" activiti:formKey="cnrfirma:approvaFlussoFirmaTask">
      <documentation>Fase Valutazione Documento</documentation>
      <extensionElements>
        <activiti:taskListener event="create" class="org.alfresco.repo.workflow.activiti.tasklistener.ScriptTaskListener">
          <activiti:field name="script">
            <activiti:string><![CDATA[<import resource="/Company Home/Data Dictionary/Scripts/wfFirmaDigitale.js">
			execution.setVariable('bpm_groupAssignee', task.getVariable('bpm_groupAssignee'));
			var commentoPrecedente = task.getVariable('bpm_comment');
			if (bpm_package !== null) {
				var nodoDocumento = bpm_package.children[0];
				nodoDocumento.properties.statoDoc = "IN_APPROVAZIONE";
				nodoDocumento.save();
				var permessiOld = nodoDocumento.getPermissions().toString();
				execution.setVariable('cnrfirma_permessiOld', permessiOld);
				var ownerOld = nodoDocumento.getOwner();
				execution.setVariable('cnrfirma_ownerOld', ownerOld);
				// logger.error("permessiOld: "  + permessiOld);
				wfFirmaDigitale.settaPermessi(nodoDocumento,bpm_groupAssignee.properties.authorityName);
				execution.setVariable('cnrfirma_ufficioAssegnatario', bpm_groupAssignee);
				var cnrfirma_ufficioAssegnatario = task.getVariable('bpm_groupAssignee');
				var members = people.getMembers(cnrfirma_ufficioAssegnatario);
				var testo = "Avvio di un flusso documentale";
				var isWorkflowPooled = true;
				// logger.error("FLUSSO FIRMA - APPROVA DOCUMENTO  invia notifica ai membri del gruppo: " + cnrfirma_ufficioAssegnatario.properties.authorityName);
				for (i = 0; i < members.length; i++) {
					var destinatario = members[i];
					// logger.error("FLUSSO FIRMA - APPROVA DOCUMENTO  invia notifica a : " + destinatario.properties.userName + " del gruppo: " + cnrfirma_ufficioAssegnatario.properties.authorityName);
					wfFirmaDigitale.inviaNotifica(destinatario, testo, isWorkflowPooled, cnrfirma_ufficioAssegnatario);
				}
				
			}
			// logger.error("FLUSSO FIRMA - APPROVA DOCUMENTO in stato: " + bpm_package.children[0].properties.statoDoc + " assegnato a: " + execution.getVariable('cnrfirma_ufficioAssegnatario').properties.authorityName);
			wfFirmaDigitale.aggiornaParametri(task);
			]]></activiti:string>
          </activiti:field>
          <activiti:field name="runAs">
            <activiti:string><![CDATA[admin]]></activiti:string>
          </activiti:field>
        </activiti:taskListener>
        <activiti:taskListener event="assignment" class="org.alfresco.repo.workflow.activiti.tasklistener.ScriptTaskListener">
          <activiti:field name="script">
            <activiti:string><![CDATA[
			execution.setVariable('bpm_assignee', task.getVariable('bpm_assignee'));
			currentTaskUser = task.getVariable('bpm_assignee');
			if ((typeof currentTaskUser != 'undefined') && (currentTaskUser)) {
				// // logger.error("FLUSSO FIRMA - APPROVA DOCUMENTO - currentTaskUser: " + currentTaskUser.properties.userName);
			} else {
				// // logger.error("FLUSSO FIRMA - APPROVA DOCUMENTO - person: " + person.properties.userName);
			}]]></activiti:string>
          </activiti:field>
          <activiti:field name="runAs">
            <activiti:string><![CDATA[admin]]></activiti:string>
          </activiti:field>
        </activiti:taskListener>
        <activiti:taskListener event="complete" class="org.alfresco.repo.workflow.activiti.tasklistener.ScriptTaskListener">
          <activiti:field name="script">
            <activiti:string><![CDATA[<import resource="/Company Home/Data Dictionary/Scripts/wfFirmaDigitale.js">
				var firmato = true;
				if (bpm_package !== null) {
					var nodoDocumento = bpm_package.children[0];
					if ((task.getVariable('wfcnr_reviewOutcome') == 'ComplexApprove')) {
						//firmato = wfFirmaDigitale.verificaDocumentoFirmato(nodoDocumento);
						var userFirma = task.getVariable('cnrfirma_userFirma');
						var userPwFirma = task.getVariable('cnrfirma_userPwFirma');
						var pinFirma = task.getVariable('cnrfirma_pinFirma');
						var folderDestination = task.getVariable('cnrfirma_nodeRefFolderToLink');
						var codiceDoc = task.getVariable('cnrfirma_codiceDocumentoUfficio');
						execution.setVariable('cnrfirma_codiceDoc', codiceDoc);
						// // logger.error("FLUSSO FIRMA - APPROVA DOCUMENTO CON FIRMA folderDestination: " + folderDestination + " con codice ufficio: " + codiceDoc);
						var ufficioAssegnatario = execution.getVariable('cnrfirma_ufficioAssegnatario').properties.authorityName;
						firmato = wfFirmaDigitale.firmaFile(userFirma, userPwFirma, pinFirma, nodoDocumento, folderDestination, ufficioAssegnatario, codiceDoc);
						// // logger.error("FLUSSO FIRMA - APPROVA DOCUMENTO CON FIRMA firmato: " + firmato + " da user: " + userFirma);
						execution.setVariable('bpm_groupAssignee', cnrfirma_ufficioAssegnatario);
					}
					if ((task.getVariable('wfcnr_reviewOutcome') == 'SimpleApprove')) {
						var folderDestination = task.getVariable('cnrfirma_nodeRefFolderToLink');
						var codiceDoc = task.getVariable('cnrfirma_codiceDocumentoUfficio');
						execution.setVariable('cnrfirma_codiceDoc', codiceDoc);
						// // logger.error("FLUSSO FIRMA - APPROVA DOCUMENTO SEMPLICE folderDestination: " + folderDestination + " con codice ufficio: " + codiceDoc);
						var ufficioAssegnatario = execution.getVariable('cnrfirma_ufficioAssegnatario').properties.authorityName;
						firmato = wfFirmaDigitale.approvaFile(nodoDocumento, folderDestination, ufficioAssegnatario, codiceDoc);
						execution.setVariable('bpm_groupAssignee', cnrfirma_ufficioAssegnatario);
						}
					if (firmato){
						execution.setVariable('wfcnr_reviewOutcome', task.getVariable('wfcnr_reviewOutcome'));
						if (task.getVariable('wfcnr_reviewOutcome') == 'AskGroupOpinion'){
							if (task.getVariable('bpm_groupAssignee')){
								execution.setVariable('bpm_groupAssignee', task.getVariable('bpm_groupAssignee'));
								nodoDocumento.setPermission("Consumer", bpm_groupAssignee.properties.authorityName);
								// // logger.error("FLUSSO FIRMA - APPROVA DOCUMENTO  assegnato a : " + task.getVariable('bpm_groupAssignee').properties.authorityName);
							}
						}
						if (task.getVariable('wfcnr_reviewOutcome') == 'AskUserOpinion') {
							if (task.getVariable('bpm_assignee')){
								nodoDocumento.setPermission("Consumer", task.getVariable('bpm_assignee').properties.userName);
								execution.setVariable('bpm_assignee', task.getVariable('bpm_assignee'));
								// // logger.error("FLUSSO FIRMA - APPROVA DOCUMENTO  assegnato a : " + task.getVariable('bpm_assignee').properties.userName);
							}
						}
						if (task.getVariable('wfcnr_reviewOutcome') == 'Reject') {
							execution.setVariable('bpm_assignee', initiator);
						}
					}
					execution.setVariable('commentoPrecedente', task.getVariable('bpm_comment'));
				}]]></activiti:string>
          </activiti:field>
          <activiti:field name="runAs">
            <activiti:string><![CDATA[admin]]></activiti:string>
          </activiti:field>
        </activiti:taskListener>
      </extensionElements>
    </userTask>
    <sequenceFlow id="flow1" name="avvia" sourceRef="avvia" targetRef="approvaDocumento"></sequenceFlow>
    <exclusiveGateway id="decisioneValutazione" name="VALUTAZIONE" default="flow13">
      <documentation>Scelta su Validazione Documento</documentation>
    </exclusiveGateway>
    <userTask id="parereUfficio" name="PARERE UFFICIO" activiti:candidateGroups="${bpm_groupAssignee.properties.authorityName}" activiti:formKey="cnrfirma:fornisciParereGruppoTask">
      <documentation>Fase di Valutazione Documento per Ufficio</documentation>
      <extensionElements>
        <activiti:taskListener event="create" class="org.alfresco.repo.workflow.activiti.tasklistener.ScriptTaskListener">
          <activiti:field name="script">
            <activiti:string><![CDATA[<import resource="/Company Home/Data Dictionary/Scripts/wfFirmaDigitale.js">
				execution.setVariable('bpm_groupAssignee', task.getVariable('bpm_groupAssignee'));
				if (bpm_package !== null) {
					var nodoDocumento = bpm_package.children[0];
					nodoDocumento.properties.statoDoc = "IN_VALUTAZIONE";
					nodoDocumento.save();
					
					var groupAssignee = task.getVariable('bpm_groupAssignee');
					var members = people.getMembers(groupAssignee);
					var testo = "Valutazione Documento per Ufficio";
					var isWorkflowPooled = true;
					// // logger.error("FLUSSO FIRMA - VALUTA DOCUMENTO  invia notifica ai membri del gruppo: " + groupAssignee.properties.authorityName);
					for (i = 0; i < members.length; i++) {
						var destinatario = members[i];
						wfFirmaDigitale.inviaNotifica(destinatario, testo, isWorkflowPooled, groupAssignee);
						// // logger.error("FLUSSO FIRMA - APPROVA DOCUMENTO  invia notifica a : " + destinatario.properties.userName + " del gruppo: " + groupAssignee.properties.authorityName);
					}
				}
				//execution.setVariable('bpm_groupAssignee', task.getVariable('bpm_groupAssignee'));
				// // logger.error("FLUSSO FIRMA - VALUTA DOCUMENTO con stato: " + bpm_package.children[0].properties.statoDoc + " assegnato al gruppo: " + task.getVariable('bpm_groupAssignee').properties.authorityName);
				wfFirmaDigitale.aggiornaParametri(task);
				]]></activiti:string>
          </activiti:field>
          <activiti:field name="runAs">
            <activiti:string><![CDATA[admin]]></activiti:string>
          </activiti:field>
        </activiti:taskListener>
        <activiti:taskListener event="assignment" class="org.alfresco.repo.workflow.activiti.tasklistener.ScriptTaskListener">
          <activiti:field name="script">
            <activiti:string><![CDATA[
			execution.setVariable('bpm_assignee', task.getVariable('bpm_assignee'));
		]]></activiti:string>
          </activiti:field>
          <activiti:field name="runAs">
            <activiti:string><![CDATA[admin]]></activiti:string>
          </activiti:field>
        </activiti:taskListener>
        <activiti:taskListener event="complete" class="org.alfresco.repo.workflow.activiti.tasklistener.ScriptTaskListener">
          <activiti:field name="script">
            <activiti:string><![CDATA[
					execution.setVariable("bpm_groupAssignee", execution.getVariable('cnrfirma_ufficioAssegnatario'));
					execution.setVariable('commentoPrecedente', task.getVariable('bpm_comment'));
					// // logger.error("FLUSSO FIRMA - DOCUMENTO VALUTATO e reinviato a:" + execution.getVariable('cnrfirma_ufficioAssegnatario').properties.authorityName);
					]]></activiti:string>
          </activiti:field>
          <activiti:field name="runAs">
            <activiti:string><![CDATA[admin]]></activiti:string>
          </activiti:field>
        </activiti:taskListener>
      </extensionElements>
    </userTask>
    <endEvent id="endevent1" name="End"></endEvent>
    <userTask id="approvatoSemplice" name="APPROVATO" activiti:assignee="${initiator.exists() ? initiator.properties.userName : 'admin'}" activiti:formKey="cnrfirma:documentoApprovatoSempliceTask">
      <documentation>Documento Approvato</documentation>
      <extensionElements>
        <activiti:taskListener event="create" class="org.alfresco.repo.workflow.activiti.tasklistener.ScriptTaskListener">
          <activiti:field name="script">
            <activiti:string><![CDATA[<import resource="/Company Home/Data Dictionary/Scripts/wfFirmaDigitale.js">
			execution.setVariable('bpm_assignee', task.getVariable('bpm_assignee'));
			if (bpm_package !== null) {
					var nodoDocumento = bpm_package.children[0];
					nodoDocumento.properties.statoDoc = "APPROVATO";
					nodoDocumento.save();
					// // logger.error("FLUSSO FIRMA - DOCUMENTO APPROVATO SEMPLICE con stato: " + nodoDocumento.properties.statoDoc);

					var destinatario = task.getVariable('bpm_assignee');
					var testo = "Documento Approvato";
					var isWorkflowPooled = false;
					var groupAssignee = "";
					// // logger.error("FLUSSO FIRMA - APPROVA DOCUMENTO  invia notifica a : " + destinatario.properties.userName);
					wfFirmaDigitale.inviaNotifica(destinatario, testo, isWorkflowPooled, groupAssignee);
					
				}
				wfFirmaDigitale.aggiornaParametri(task);
				]]></activiti:string>
          </activiti:field>
          <activiti:field name="runAs">
            <activiti:string><![CDATA[admin]]></activiti:string>
          </activiti:field>
        </activiti:taskListener>
        <activiti:taskListener event="complete" class="org.alfresco.repo.workflow.activiti.tasklistener.ScriptTaskListener">
          <activiti:field name="script">
            <activiti:string><![CDATA[<import resource="/Company Home/Data Dictionary/Scripts/wfFirmaDigitale.js">
				// // logger.error("FLUSSO FIRMA - DOCUMENTO APPROVATO SEMPLICE  - END");
				execution.setVariable('bpm_assignee', initiator);
				if (bpm_package !== null) {
					var nodoDocumento = bpm_package.children[0];
					nodoDocumento.removePermission("Collaborator", execution.getVariable('cnrfirma_ufficioAssegnatario').properties.authorityName);
					var destinatario = initiator;
					var testo = "Valutazione Documento per Utente";
					var isWorkflowPooled = false;
					var groupAssignee = "";
					// // logger.error("FLUSSO FIRMA - APPROVA DOCUMENTO  invia notifica a : " + destinatario.properties.userName);
					wfFirmaDigitale.inviaNotifica(destinatario, testo, isWorkflowPooled, groupAssignee);
					execution.setVariable('commentoPrecedente', task.getVariable('bpm_comment'));
				}]]></activiti:string>
          </activiti:field>
          <activiti:field name="runAs">
            <activiti:string><![CDATA[admin]]></activiti:string>
          </activiti:field>
        </activiti:taskListener>
      </extensionElements>
    </userTask>
    <userTask id="respinto" name="RESPINTO" activiti:assignee="${initiator.exists() ? initiator.properties.userName : 'admin'}" activiti:formKey="cnrfirma:documentoRespintoTask">
      <documentation>Documento Respinto</documentation>
      <extensionElements>
        <activiti:taskListener event="create" class="org.alfresco.repo.workflow.activiti.tasklistener.ScriptTaskListener">
          <activiti:field name="script">
            <activiti:string><![CDATA[<import resource="/Company Home/Data Dictionary/Scripts/wfFirmaDigitale.js">
			execution.setVariable('bpm_assignee', task.getVariable('bpm_assignee'));
			if (bpm_package !== null) {
					var nodoDocumento = bpm_package.children[0];
					nodoDocumento.properties.statoDoc = "RESPINTO";
					nodoDocumento.save();
					wfFirmaDigitale.ripristinaPermessi(nodoDocumento,execution.getVariable('cnrfirma_ufficioAssegnatario').properties.authorityName, execution.getVariable('cnrfirma_permessiOld'), cnrfirma_ownerOld);
					nodoDocumento.removePermission("Collaborator", execution.getVariable('cnrfirma_ufficioAssegnatario').properties.authorityName);
				
					var destinatario = task.getVariable('bpm_assignee');
					var testo = "Documento Respinto";
					var isWorkflowPooled = false;
					var groupAssignee = "";
					// // logger.error("FLUSSO FIRMA - APPROVA DOCUMENTO  invia notifica a : " + destinatario.properties.userName);
					wfFirmaDigitale.inviaNotifica(destinatario, testo, isWorkflowPooled, groupAssignee);
					
				}
				// // logger.error("FLUSSO FIRMA - DOCUMENTO RESPINTO con stato: " + bpm_package.children[0].properties.statoDoc);
				wfFirmaDigitale.aggiornaParametri(task);
				]]></activiti:string>
          </activiti:field>
          <activiti:field name="runAs">
            <activiti:string><![CDATA[admin]]></activiti:string>
          </activiti:field>
        </activiti:taskListener>
        <activiti:taskListener event="complete" class="org.alfresco.repo.workflow.activiti.tasklistener.ScriptTaskListener">
          <activiti:field name="script">
            <activiti:string><![CDATA[<import resource="/Company Home/Data Dictionary/Scripts/wfFirmaDigitale.js">
				// // logger.error("FLUSSO FIRMA - DOCUMENTO RESPINTO  - END");
				execution.setVariable('bpm_assignee', initiator);
				if (bpm_package !== null) {
					var destinatario = initiator;
					var testo = "Valutazione Documento per Utente";
					var isWorkflowPooled = false;
					var groupAssignee = "";
					// // logger.error("FLUSSO FIRMA - APPROVA DOCUMENTO  invia notifica a : " + destinatario.properties.userName);
					execution.setVariable('commentoPrecedente', task.getVariable('bpm_comment'));
					wfFirmaDigitale.inviaNotifica(destinatario, testo, isWorkflowPooled, groupAssignee);
				}]]></activiti:string>
          </activiti:field>
          <activiti:field name="runAs">
            <activiti:string><![CDATA[admin]]></activiti:string>
          </activiti:field>
        </activiti:taskListener>
      </extensionElements>
    </userTask>
    <sequenceFlow id="flow12" sourceRef="approvaDocumento" targetRef="decisioneValutazione"></sequenceFlow>
    <sequenceFlow id="flow13" name="rifiuta" sourceRef="decisioneValutazione" targetRef="respinto"></sequenceFlow>
    <sequenceFlow id="flow14" name="approva semplice" sourceRef="decisioneValutazione" targetRef="approvatoSemplice">
      <conditionExpression xsi:type="tFormalExpression"><![CDATA[${wfcnr_reviewOutcome == 'SimpleApprove'}]]></conditionExpression>
    </sequenceFlow>
    <userTask id="approvatoFirma" name="FIRMATO" activiti:assignee="${initiator.exists() ? initiator.properties.userName : 'admin'}" activiti:formKey="cnrfirma:documentoApprovatoFirmatoTask">
      <documentation>Documento Approvato con Firma</documentation>
      <extensionElements>
        <activiti:taskListener event="create" class="org.alfresco.repo.workflow.activiti.tasklistener.ScriptTaskListener">
          <activiti:field name="script">
            <activiti:string><![CDATA[<import resource="/Company Home/Data Dictionary/Scripts/wfFirmaDigitale.js">
			execution.setVariable('bpm_assignee', task.getVariable('bpm_assignee'));
			if (bpm_package !== null) {
					var nodoDocumento = bpm_package.children[0];
					nodoDocumento.properties.statoDoc = "FIRMATO";
					nodoDocumento.save();
					// // logger.error("FLUSSO FIRMA - DOCUMENTO APPROVATO CON FIRMA con stato: " + nodoDocumento.properties.statoDoc);
					

					var destinatario = task.getVariable('bpm_assignee');
					var testo = "Documento Approvato con Firma";
					var isWorkflowPooled = false;
					var groupAssignee = "";
					// // logger.error("FLUSSO FIRMA - APPROVA DOCUMENTO  invia notifica a : " + destinatario.properties.userName);
					wfFirmaDigitale.inviaNotifica(destinatario, testo, isWorkflowPooled, groupAssignee);
				}
				wfFirmaDigitale.aggiornaParametri(task);
				]]></activiti:string>
          </activiti:field>
          <activiti:field name="runAs">
            <activiti:string><![CDATA[admin]]></activiti:string>
          </activiti:field>
        </activiti:taskListener>
        <activiti:taskListener event="complete" class="org.alfresco.repo.workflow.activiti.tasklistener.ScriptTaskListener">
          <activiti:field name="script">
            <activiti:string><![CDATA[<import resource="/Company Home/Data Dictionary/Scripts/wfFirmaDigitale.js">
				// // logger.error("FLUSSO FIRMA - DOCUMENTO APPROVATO CON FIRMA  - END");
				execution.setVariable('bpm_assignee', initiator);
				if (bpm_package !== null) {
					var nodoDocumento = bpm_package.children[0];
					nodoDocumento.removePermission("Collaborator", execution.getVariable('cnrfirma_ufficioAssegnatario').properties.authorityName);
					var destinatario = initiator;
					var testo = "Valutazione Documento per Utente";
					var isWorkflowPooled = false;
					var groupAssignee = "";
					// // logger.error("FLUSSO FIRMA - APPROVA DOCUMENTO  invia notifica a : " + destinatario.properties.userName);
					execution.setVariable('commentoPrecedente', task.getVariable('bpm_comment'));
					wfFirmaDigitale.inviaNotifica(destinatario, testo, isWorkflowPooled, groupAssignee);
				}]]></activiti:string>
          </activiti:field>
          <activiti:field name="runAs">
            <activiti:string><![CDATA[admin]]></activiti:string>
          </activiti:field>
        </activiti:taskListener>
      </extensionElements>
    </userTask>
    <sequenceFlow id="flow18" sourceRef="approvatoFirma" targetRef="endevent1"></sequenceFlow>
    <sequenceFlow id="flow19" sourceRef="approvatoSemplice" targetRef="endevent1"></sequenceFlow>
    <sequenceFlow id="flow22" sourceRef="respinto" targetRef="endevent1"></sequenceFlow>
    <sequenceFlow id="flow23" name="approva con firma" sourceRef="decisioneValutazione" targetRef="approvatoFirma">
      <conditionExpression xsi:type="tFormalExpression"><![CDATA[${wfcnr_reviewOutcome == 'ComplexApprove'}]]></conditionExpression>
    </sequenceFlow>
    <userTask id="parereUtente" name="PARERE UTENTE" activiti:assignee="${bpm_assignee.properties.userName}" activiti:formKey="cnrfirma:fornisciParereTask">
      <documentation>Fase di Valutazione Documento per Utente</documentation>
      <extensionElements>
        <activiti:taskListener event="create" class="org.alfresco.repo.workflow.activiti.tasklistener.ScriptTaskListener">
          <activiti:field name="script">
            <activiti:string><![CDATA[<import resource="/Company Home/Data Dictionary/Scripts/wfFirmaDigitale.js">
				// // logger.error("FLUSSO FIRMA - APPROVA DOCUMENTO  task.owner : " + task.owner);
				//task.owner = task.getVariable('bpm_assignee').properties.userName;
				execution.setVariable('bpm_assignee', task.getVariable('bpm_assignee'));
				if (bpm_package !== null) {
					var nodoDocumento = bpm_package.children[0];
					nodoDocumento.properties.statoDoc = "IN_VALUTAZIONE";
					nodoDocumento.save();
					
					var destinatario = task.getVariable('bpm_assignee');
					var testo = "Valutazione Documento per Utente";
					var isWorkflowPooled = false;
					var groupAssignee = "";
					// // logger.error("FLUSSO FIRMA - APPROVA DOCUMENTO  invia notifica a : " + destinatario.properties.userName);
					wfFirmaDigitale.inviaNotifica(destinatario, testo, isWorkflowPooled, groupAssignee);
				}
				// // logger.error("FLUSSO FIRMA - VALUTA DOCUMENTO con stato: " + bpm_package.children[0].properties.statoDoc + " assegnato all'utente: " + task.getVariable('bpm_assignee'));
				wfFirmaDigitale.aggiornaParametri(task);
				]]></activiti:string>
          </activiti:field>
          <activiti:field name="runAs">
            <activiti:string><![CDATA[admin]]></activiti:string>
          </activiti:field>
        </activiti:taskListener>
        <activiti:taskListener event="complete" class="org.alfresco.repo.workflow.activiti.tasklistener.ScriptTaskListener">
          <activiti:field name="script">
            <activiti:string><![CDATA[
				execution.setVariable("bpm_groupAssignee", execution.getVariable('cnrfirma_ufficioAssegnatario'));
				execution.setVariable('commentoPrecedente', task.getVariable('bpm_comment'));
				// // logger.error("FLUSSO FIRMA - DOCUMENTO VALUTATO e reinviato a:" + execution.getVariable('cnrfirma_ufficioAssegnatario').properties.authorityName);
				]]></activiti:string>
          </activiti:field>
          <activiti:field name="runAs">
            <activiti:string><![CDATA[admin]]></activiti:string>
          </activiti:field>
        </activiti:taskListener>
      </extensionElements>
    </userTask>
    <sequenceFlow id="flow27" name="parere ufficio" sourceRef="decisioneValutazione" targetRef="parereUfficio">
      <conditionExpression xsi:type="tFormalExpression"><![CDATA[${wfcnr_reviewOutcome == 'AskGroupOpinion'}]]></conditionExpression>
    </sequenceFlow>
    <sequenceFlow id="flow28" name="parere utente" sourceRef="decisioneValutazione" targetRef="parereUtente">
      <conditionExpression xsi:type="tFormalExpression"><![CDATA[${wfcnr_reviewOutcome == 'AskUserOpinion'}]]></conditionExpression>
    </sequenceFlow>
    <sequenceFlow id="flow29" sourceRef="parereUtente" targetRef="approvaDocumento"></sequenceFlow>
    <sequenceFlow id="flow30" sourceRef="parereUfficio" targetRef="approvaDocumento"></sequenceFlow>
  </process>
  <bpmndi:BPMNDiagram id="BPMNDiagram_flussoFirma">
    <bpmndi:BPMNPlane bpmnElement="flussoFirma" id="BPMNPlane_flussoFirma">
      <bpmndi:BPMNShape bpmnElement="avvia" id="BPMNShape_avvia">
        <omgdc:Bounds height="35.0" width="35.0" x="245.0" y="20.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="approvaDocumento" id="BPMNShape_approvaDocumento">
        <omgdc:Bounds height="61.0" width="156.0" x="185.0" y="110.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="decisioneValutazione" id="BPMNShape_decisioneValutazione">
        <omgdc:Bounds height="40.0" width="40.0" x="242.0" y="247.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="parereUfficio" id="BPMNShape_parereUfficio">
        <omgdc:Bounds height="61.0" width="156.0" x="370.0" y="237.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="endevent1" id="BPMNShape_endevent1">
        <omgdc:Bounds height="35.0" width="35.0" x="245.0" y="481.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="approvatoSemplice" id="BPMNShape_approvatoSemplice">
        <omgdc:Bounds height="58.0" width="156.0" x="370.0" y="350.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="respinto" id="BPMNShape_respinto">
        <omgdc:Bounds height="62.0" width="151.0" x="10.0" y="348.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="approvatoFirma" id="BPMNShape_approvatoFirma">
        <omgdc:Bounds height="58.0" width="157.0" x="184.0" y="350.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="parereUtente" id="BPMNShape_parereUtente">
        <omgdc:Bounds height="63.0" width="151.0" x="10.0" y="236.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge bpmnElement="flow1" id="BPMNEdge_flow1">
        <omgdi:waypoint x="262.0" y="55.0"></omgdi:waypoint>
        <omgdi:waypoint x="263.0" y="110.0"></omgdi:waypoint>
        <bpmndi:BPMNLabel>
          <omgdc:Bounds height="14.0" width="26.0" x="10.0" y="0.0"></omgdc:Bounds>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow12" id="BPMNEdge_flow12">
        <omgdi:waypoint x="263.0" y="171.0"></omgdi:waypoint>
        <omgdi:waypoint x="262.0" y="247.0"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow13" id="BPMNEdge_flow13">
        <omgdi:waypoint x="262.0" y="287.0"></omgdi:waypoint>
        <omgdi:waypoint x="85.0" y="348.0"></omgdi:waypoint>
        <bpmndi:BPMNLabel>
          <omgdc:Bounds height="14.0" width="27.0" x="-70.0" y="6.0"></omgdc:Bounds>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow14" id="BPMNEdge_flow14">
        <omgdi:waypoint x="262.0" y="287.0"></omgdi:waypoint>
        <omgdi:waypoint x="448.0" y="350.0"></omgdi:waypoint>
        <bpmndi:BPMNLabel>
          <omgdc:Bounds height="14.0" width="85.0" x="60.0" y="13.0"></omgdc:Bounds>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow18" id="BPMNEdge_flow18">
        <omgdi:waypoint x="262.0" y="408.0"></omgdi:waypoint>
        <omgdi:waypoint x="262.0" y="481.0"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow19" id="BPMNEdge_flow19">
        <omgdi:waypoint x="448.0" y="408.0"></omgdi:waypoint>
        <omgdi:waypoint x="447.0" y="498.0"></omgdi:waypoint>
        <omgdi:waypoint x="280.0" y="498.0"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow22" id="BPMNEdge_flow22">
        <omgdi:waypoint x="85.0" y="410.0"></omgdi:waypoint>
        <omgdi:waypoint x="85.0" y="498.0"></omgdi:waypoint>
        <omgdi:waypoint x="245.0" y="498.0"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow23" id="BPMNEdge_flow23">
        <omgdi:waypoint x="262.0" y="287.0"></omgdi:waypoint>
        <omgdi:waypoint x="262.0" y="350.0"></omgdi:waypoint>
        <bpmndi:BPMNLabel>
          <omgdc:Bounds height="14.0" width="88.0" x="9.0" y="9.0"></omgdc:Bounds>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow27" id="BPMNEdge_flow27">
        <omgdi:waypoint x="282.0" y="267.0"></omgdi:waypoint>
        <omgdi:waypoint x="370.0" y="267.0"></omgdi:waypoint>
        <bpmndi:BPMNLabel>
          <omgdc:Bounds height="14.0" width="65.0" x="-40.0" y="-20.0"></omgdc:Bounds>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow28" id="BPMNEdge_flow28">
        <omgdi:waypoint x="242.0" y="267.0"></omgdi:waypoint>
        <omgdi:waypoint x="161.0" y="267.0"></omgdi:waypoint>
        <bpmndi:BPMNLabel>
          <omgdc:Bounds height="14.0" width="65.0" x="-29.0" y="-20.0"></omgdc:Bounds>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow29" id="BPMNEdge_flow29">
        <omgdi:waypoint x="85.0" y="236.0"></omgdi:waypoint>
        <omgdi:waypoint x="85.0" y="140.0"></omgdi:waypoint>
        <omgdi:waypoint x="185.0" y="140.0"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow30" id="BPMNEdge_flow30">
        <omgdi:waypoint x="448.0" y="237.0"></omgdi:waypoint>
        <omgdi:waypoint x="447.0" y="140.0"></omgdi:waypoint>
        <omgdi:waypoint x="341.0" y="140.0"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</definitions>