<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:activiti="http://activiti.org/bpmn" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:omgdc="http://www.omg.org/spec/DD/20100524/DC" xmlns:omgdi="http://www.omg.org/spec/DD/20100524/DI" typeLanguage="http://www.w3.org/2001/XMLSchema" expressionLanguage="http://www.w3.org/1999/XPath" targetNamespace="http://www.activiti.org">
	<process id="flussoAttestati" name="FLUSSO ATTESTATI" isExecutable="true">
		<extensionElements>
			<activiti:executionListener event="start" class="org.alfresco.repo.workflow.activiti.listener.ScriptExecutionListener">
				<activiti:field name="script">
					<activiti:string>
						<![CDATA[<import resource="/Company Home/Data Dictionary/Scripts/wfContatori.js">
						<import resource="/Company Home/Data Dictionary/Scripts/wfCommon.js">
						<import resource="/Company Home/Data Dictionary/Scripts/wfFlussoAttestati.js">
						wfFlussoAttestati.setNomeFlusso();
						wfCommon.verificaDocInUnicoFlusso(bpm_package);
						wfContatori.inizializza();
						wfContatori.copiaDocInCatellaFlussi();
						wfCommon.verificaUnicoDocAllegato(bpm_package);
						wfFlussoAttestati.flussoAttestatiSartSettings();]]></activiti:string>
				</activiti:field>
				<activiti:field name="runAs">
					<activiti:string>
						<![CDATA[admin]]>
					</activiti:string>
				</activiti:field>
			</activiti:executionListener>
			<activiti:executionListener event="end" class="org.alfresco.repo.workflow.activiti.listener.ScriptExecutionListener">
				<activiti:field name="script">
					<activiti:string>
						<![CDATA[<import resource="/Company Home/Data Dictionary/Scripts/wfFlussoAttestati.js">
						<import resource="/Company Home/Data Dictionary/Scripts/wfCommon.js">
						logger.error("FLUSSO ATTESTATI - END");
						wfFlussoAttestati.flussoAttestatiEndSettings();]]></activiti:string>
				</activiti:field>
				<activiti:field name="runAs">
					<activiti:string>
						<![CDATA[admin]]>
					</activiti:string>
				</activiti:field>
			</activiti:executionListener>
		</extensionElements>
		<startEvent id="avviaflussoAttestati" name="Avvia FLUSSO ATTESTATI" activiti:formKey="cnrattestati:submitFlussoAttestatiTask">
			<documentation>avvio Flusso per gli Attestati</documentation>
		</startEvent>
		<endEvent id="fineFlusso" name="fine Flusso Attestati"/>
		<userTask id="validazioneTask" name="VALIDAZIONE" activiti:assignee="${bpm_assignee.properties.userName}" activiti:formKey="cnrattestati:validaTask">
			<extensionElements>
				<activiti:taskListener event="create" class="org.alfresco.repo.workflow.activiti.tasklistener.ScriptTaskListener">
					<activiti:field name="script">
						<activiti:string>
							<![CDATA[<import resource="/Company Home/Data Dictionary/Scripts/wfFlussoAttestati.js">
							<import resource="/Company Home/Data Dictionary/Scripts/wfCommon.js">
							logger.error("FLUSSO ATTESTATI - VALIDAZIONE");
							wfFlussoAttestati.validazione();]]></activiti:string>
					</activiti:field>
					<activiti:field name="runAs">
						<activiti:string>
							<![CDATA[admin]]>
						</activiti:string>
					</activiti:field>
				</activiti:taskListener>
				<activiti:taskListener event="complete" class="org.alfresco.repo.workflow.activiti.tasklistener.ScriptTaskListener">
					<activiti:field name="script">
						<activiti:string>
							<![CDATA[<import resource="/Company Home/Data Dictionary/Scripts/wfFlussoAttestati.js">
							<import resource="/Company Home/Data Dictionary/Scripts/wfCommon.js">
							logger.error("FLUSSO ATTESTATI - VALIDAZIONE END");
							wfFlussoAttestati.validazioneEnd();]]></activiti:string>
					</activiti:field>
					<activiti:field name="runAs">
						<activiti:string>
							<![CDATA[admin]]>
						</activiti:string>
					</activiti:field>
				</activiti:taskListener>
			</extensionElements>
		</userTask>
		<exclusiveGateway id="exclusivegateway1" name="Exclusive Gateway" default="flow21"/>
		<sequenceFlow id="flow3" name="valida?" sourceRef="validazioneTask" targetRef="exclusivegateway1"/>
		<sequenceFlow id="flow13" name="avvia" sourceRef="avviaflussoAttestati" targetRef="validazioneTask"/>
		<scriptTask id="scripttask1" name="APPROVATO" scriptFormat="javascript" activiti:autoStoreVariables="false">
			<extensionElements>
				<activiti:executionListener event="start" class="org.alfresco.repo.workflow.activiti.listener.ScriptExecutionListener">
					<activiti:field name="script">
						<activiti:string>
							<![CDATA[<import resource="/Company Home/Data Dictionary/Scripts/wfFlussoAttestati.js">
							<import resource="/Company Home/Data Dictionary/Scripts/wfCommon.js">
							logger.error("FLUSSO ATTESTATI - APPROVATO");
							wfFlussoAttestati.Approva();]]></activiti:string>
					</activiti:field>
					<activiti:field name="runAs">
						<activiti:string>
							<![CDATA[admin]]>
						</activiti:string>
					</activiti:field>
				</activiti:executionListener>
			</extensionElements>
			<script/>
		</scriptTask>
		<sequenceFlow id="flow16" sourceRef="scripttask1" targetRef="fineFlusso"/>
		<userTask id="respintoTask" name="RESPINTO" activiti:candidateGroups="${wfvarResponsabiliATTESTATI}" activiti:formKey="cnrattestati:respintoTask">
			<extensionElements>
				<activiti:taskListener event="create" class="org.alfresco.repo.workflow.activiti.tasklistener.ScriptTaskListener">
					<activiti:field name="script">
						<activiti:string>
							<![CDATA[<import resource="/Company Home/Data Dictionary/Scripts/wfFlussoAttestati.js">
							<import resource="/Company Home/Data Dictionary/Scripts/wfCommon.js">
							logger.error("FLUSSO ATTESTATI - respinto");
							wfFlussoAttestati.respinto();]]></activiti:string>
					</activiti:field>
					<activiti:field name="runAs">
						<activiti:string>
							<![CDATA[admin]]>
						</activiti:string>
					</activiti:field>
				</activiti:taskListener>
				<activiti:taskListener event="complete" class="org.alfresco.repo.workflow.activiti.tasklistener.ScriptTaskListener">
					<activiti:field name="script">
						<activiti:string>
							<![CDATA[<import resource="/Company Home/Data Dictionary/Scripts/wfFlussoAttestati.js">
							<import resource="/Company Home/Data Dictionary/Scripts/wfCommon.js">
							logger.error("FLUSSO ATTESTATI - respinto END");
							wfFlussoAttestati.respintoEnd();]]></activiti:string>
					</activiti:field>
					<activiti:field name="runAs">
						<activiti:string>
							<![CDATA[admin]]>
						</activiti:string>
					</activiti:field>
				</activiti:taskListener>
			</extensionElements>
		</userTask>
		<exclusiveGateway id="exclusivegateway2" name="Exclusive Gateway" default="flow19"/>
		<sequenceFlow id="flow19" name="NO" sourceRef="exclusivegateway2" targetRef="fineFlusso"/>
		<sequenceFlow id="flow20" name="SI" sourceRef="exclusivegateway2" targetRef="validazioneTask">
			<conditionExpression xsi:type="tFormalExpression">
				<![CDATA[${wfcnr_reviewOutcome == 'Riproponi'}]]>
			</conditionExpression>
		</sequenceFlow>
		<sequenceFlow id="flow21" name="NO" sourceRef="exclusivegateway1" targetRef="respintoTask"/>
		<sequenceFlow id="flow22" name="riproponi?" sourceRef="respintoTask" targetRef="exclusivegateway2"/>
		<sequenceFlow id="flow23" name="SI" sourceRef="exclusivegateway1" targetRef="scripttask1">
			<conditionExpression xsi:type="tFormalExpression">
				<![CDATA[${wfcnr_reviewOutcome == 'Approva'}]]>
			</conditionExpression>
		</sequenceFlow>
	</process>
	<bpmndi:BPMNDiagram id="BPMNDiagram_flussoAttestati">
		<bpmndi:BPMNPlane bpmnElement="flussoAttestati" id="BPMNPlane_flussoAttestati">
			<bpmndi:BPMNShape bpmnElement="avviaflussoAttestati" id="BPMNShape_avviaflussoAttestati">
				<omgdc:Bounds height="35.0" width="35.0" x="85.0" y="8.0"/>
			</bpmndi:BPMNShape>
			<bpmndi:BPMNShape bpmnElement="fineFlusso" id="BPMNShape_fineFlusso">
				<omgdc:Bounds height="35.0" width="35.0" x="85.0" y="290.0"/>
			</bpmndi:BPMNShape>
			<bpmndi:BPMNShape bpmnElement="validazioneTask" id="BPMNShape_validazioneTask">
				<omgdc:Bounds height="55.0" width="105.0" x="50.0" y="70.0"/>
			</bpmndi:BPMNShape>
			<bpmndi:BPMNShape bpmnElement="exclusivegateway1" id="BPMNShape_exclusivegateway1">
				<omgdc:Bounds height="40.0" width="40.0" x="82.0" y="158.0"/>
			</bpmndi:BPMNShape>
			<bpmndi:BPMNShape bpmnElement="scripttask1" id="BPMNShape_scripttask1">
				<omgdc:Bounds height="55.0" width="105.0" x="50.0" y="218.0"/>
			</bpmndi:BPMNShape>
			<bpmndi:BPMNShape bpmnElement="respintoTask" id="BPMNShape_respintoTask">
				<omgdc:Bounds height="55.0" width="105.0" x="154.0" y="151.0"/>
			</bpmndi:BPMNShape>
			<bpmndi:BPMNShape bpmnElement="exclusivegateway2" id="BPMNShape_exclusivegateway2">
				<omgdc:Bounds height="40.0" width="40.0" x="304.0" y="158.0"/>
			</bpmndi:BPMNShape>
			<bpmndi:BPMNEdge bpmnElement="flow3" id="BPMNEdge_flow3">
				<omgdi:waypoint x="102.0" y="125.0"/>
				<omgdi:waypoint x="102.0" y="158.0"/>
				<bpmndi:BPMNLabel>
					<omgdc:Bounds height="14.0" width="34.0" x="-39.0" y="4.0"/>
				</bpmndi:BPMNLabel>
			</bpmndi:BPMNEdge>
			<bpmndi:BPMNEdge bpmnElement="flow13" id="BPMNEdge_flow13">
				<omgdi:waypoint x="102.0" y="43.0"/>
				<omgdi:waypoint x="102.0" y="70.0"/>
				<bpmndi:BPMNLabel>
					<omgdc:Bounds height="14.0" width="26.0" x="-35.0" y="-11.0"/>
				</bpmndi:BPMNLabel>
			</bpmndi:BPMNEdge>
			<bpmndi:BPMNEdge bpmnElement="flow16" id="BPMNEdge_flow16">
				<omgdi:waypoint x="102.0" y="273.0"/>
				<omgdi:waypoint x="102.0" y="290.0"/>
			</bpmndi:BPMNEdge>
			<bpmndi:BPMNEdge bpmnElement="flow19" id="BPMNEdge_flow19">
				<omgdi:waypoint x="324.0" y="198.0"/>
				<omgdi:waypoint x="323.0" y="307.0"/>
				<omgdi:waypoint x="120.0" y="307.0"/>
				<bpmndi:BPMNLabel>
					<omgdc:Bounds height="14.0" width="15.0" x="-154.0" y="-156.0"/>
				</bpmndi:BPMNLabel>
			</bpmndi:BPMNEdge>
			<bpmndi:BPMNEdge bpmnElement="flow20" id="BPMNEdge_flow20">
				<omgdi:waypoint x="324.0" y="158.0"/>
				<omgdi:waypoint x="323.0" y="97.0"/>
				<omgdi:waypoint x="155.0" y="97.0"/>
				<bpmndi:BPMNLabel>
					<omgdc:Bounds height="14.0" width="9.0" x="41.0" y="27.0"/>
				</bpmndi:BPMNLabel>
			</bpmndi:BPMNEdge>
			<bpmndi:BPMNEdge bpmnElement="flow21" id="BPMNEdge_flow21">
				<omgdi:waypoint x="122.0" y="178.0"/>
				<omgdi:waypoint x="154.0" y="178.0"/>
				<bpmndi:BPMNLabel>
					<omgdc:Bounds height="14.0" width="15.0" x="166.0" y="27.0"/>
				</bpmndi:BPMNLabel>
			</bpmndi:BPMNEdge>
			<bpmndi:BPMNEdge bpmnElement="flow22" id="BPMNEdge_flow22">
				<omgdi:waypoint x="259.0" y="178.0"/>
				<omgdi:waypoint x="304.0" y="178.0"/>
				<bpmndi:BPMNLabel>
					<omgdc:Bounds height="14.0" width="48.0" x="-19.0" y="-20.0"/>
				</bpmndi:BPMNLabel>
			</bpmndi:BPMNEdge>
			<bpmndi:BPMNEdge bpmnElement="flow23" id="BPMNEdge_flow23">
				<omgdi:waypoint x="102.0" y="198.0"/>
				<omgdi:waypoint x="102.0" y="218.0"/>
				<bpmndi:BPMNLabel>
					<omgdc:Bounds height="14.0" width="100.0" x="9.0" y="-10.0"/>
				</bpmndi:BPMNLabel>
			</bpmndi:BPMNEdge>
		</bpmndi:BPMNPlane>
	</bpmndi:BPMNDiagram>
</definitions>